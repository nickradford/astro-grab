---
import Layout from "../layouts/Layout.astro";
import Hero from "../components/Hero.astro";
import Installation from "../components/Installation.astro";
import Card from "../components/Card.astro";
import ShortcutDisplay from "../components/ShortcutDisplay.astro";

import Footer from "../components/Footer.astro";
---

<Layout title="astro-grab - Visual element targeting for Astro">
  <main>
    <Hero />

    <section class="bg-black py-24">
      <div class="mx-auto max-w-4xl px-4 text-center sm:px-6 lg:px-8">
        <h2
          class="mb-16 text-2xl font-bold tracking-wider text-white uppercase"
        >
          Try It Now
        </h2>
        <div id="steps-container" class="mb-12 text-left max-w-lg mx-auto">
          <ol class="list-decimal list-inside space-y-2 text-gray-300">
             <li id="step-1">Hit <kbd class="bg-gray-800 px-2 py-1 font-mono text-xs text-white"><ShortcutDisplay /></kbd> to enter targeting mode</li>
            <li id="step-2" style="height: 0; overflow: hidden; opacity: 0; transition: height 0.3s ease, opacity 0.3s ease;">Click on any component on this page</li>
            <li id="step-3" style="height: 0; overflow: hidden; opacity: 0; transition: height 0.3s ease, opacity 0.3s ease;">Paste the copied code into the textarea below</li>
            <li id="step-4" style="height: 0; overflow: hidden; opacity: 0; transition: height 0.3s ease, opacity 0.3s ease;">Now your AI agent has better context for editing</li>
          </ol>
        </div>
        <!-- Fake Terminal -->
        <div class="mx-auto max-w-2xl">
          <div class="bg-gray-900 rounded-lg p-6 font-mono text-sm text-green-400 border border-gray-700">
            <div class="flex items-center mb-4">
              <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
              <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
              <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
              <span class="text-gray-400 text-xs">agent@astro-grab</span>
            </div>
            <div class="space-y-4 text-left">
              <div>
                <span class="text-green-400 font-bold">Clog:</span>
                <span class="text-gray-300 ml-2">What's next on your plate?</span>
              </div>
              <div class="bg-gray-800 p-3 rounded">
                <textarea
                  id="code-input"
                  class="w-full bg-transparent border-none outline-none resize-none text-gray-300 font-mono text-sm placeholder-gray-500 overflow-hidden"
                  rows="6"
                  placeholder="// Paste your copied component code here"
                ></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <Installation />
  </main>

  <Footer />

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const textarea = document.getElementById('code-input');
      const step2 = document.getElementById('step-2');
      const step3 = document.getElementById('step-3');
      const step4 = document.getElementById('step-4');
      let hasPasted = false;

      // Timing tracking
      let cmdgTime: number | null = null;
      let step1Time: number | null = null;
      let step2Time: number | null = null;

      // Advanced tracking
      let step1Count = 0;
      let integrationViewed = false;

      if (textarea) {
        textarea.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = this.scrollHeight + 'px';
        });
        // Dispatch paste event when content is added
        const handleInput = () => {
          if ((textarea as HTMLTextAreaElement).value.trim().length > 0 && !hasPasted) {
            hasPasted = true;
            window.dispatchEvent(new CustomEvent('demo:text-pasted'));
          }
        };
        textarea.addEventListener('input', handleInput);
      }

      // Listen for initial keypress
      window.addEventListener('astro-grab:key-held', () => {
        cmdgTime = Date.now();
        if ((window as any).umami) {
          (window as any).umami.track('cmd-g');
        }
      });

      // Listen for targeting mode start
      window.addEventListener('astro-grab:targeting-mode-started', () => {
        step1Time = Date.now();
        step1Count++;
        if ((window as any).umami) {
          (window as any).umami.track('step-1');
          // Track repeat walkthroughs
          if (step1Count > 1) {
            (window as any).umami.track('repeat-walkthrough', { count: step1Count });
          }
        }
        setTimeout(() => {
          if (step2) {
            const targetHeight = step2.scrollHeight;
            step2.style.height = targetHeight + 'px';
            step2.style.opacity = '1';
          }
        }, 100);
      });

      // Listen for component targeted
      window.addEventListener('astro-grab:component-targeted', (event: any) => {
        step2Time = Date.now();
        if ((window as any).umami) {
          (window as any).umami.track('step-2', { el: event.detail?.el });
          // Track step-1 to step-2 duration
          if (step1Time) {
            const duration = step2Time - step1Time;
            (window as any).umami.track('step-1-to-step-2-time', { duration });
          }
        }
        setTimeout(() => {
          if (step3 && textarea) {
            const targetHeight = step3.scrollHeight;
            step3.style.height = targetHeight + 'px';
            step3.style.opacity = '1';
            textarea.focus();
          }
        }, 100);
      });

      // Listen for text pasted
      window.addEventListener('demo:text-pasted', () => {
        const step3Time = Date.now();
        if ((window as any).umami) {
          (window as any).umami.track('step-3');
          // Track step-2 to step-3 duration
          if (step2Time) {
            const duration = step3Time - step2Time;
            (window as any).umami.track('step-2-to-step-3-time', { duration });
          }
          // Track total walkthrough time
          if (cmdgTime) {
            const totalDuration = step3Time - cmdgTime;
            (window as any).umami.track('total-walkthrough-time', { duration: totalDuration });
          }
        }
        setTimeout(() => {
          if (step4) {
            const targetHeight = step4.scrollHeight;
            step4.style.height = targetHeight + 'px';
            step4.style.opacity = '1';
          }
        }, 100);
      });

      // Listen for keypress too short (didn't hold long enough)
      window.addEventListener('astro-grab:keypress-too-short', () => {
        if ((window as any).umami) {
          (window as any).umami.track('keypress-too-short');
        }
      });

      // Listen for targeting cancelled (escape key)
      window.addEventListener('astro-grab:targeting-cancelled', () => {
        if ((window as any).umami) {
          (window as any).umami.track('targeting-cancelled');
        }
      });

      // Track integration section visibility
      const integrationSection = document.getElementById('installation');
      if (integrationSection && (window as any).IntersectionObserver) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting && !integrationViewed) {
              integrationViewed = true;
              if ((window as any).umami) {
                (window as any).umami.track('integration-attempted');
              }
            }
          });
        }, { threshold: 0.1 });
        observer.observe(integrationSection);
      }
    });
  </script>
</Layout>
