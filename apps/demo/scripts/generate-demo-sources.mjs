import { glob } from "glob";
import { readFile, writeFile } from "fs/promises";
import { relative } from "path";

console.log("ðŸ” Scanning .astro files in src/...");

const astroFiles = await glob("src/**/*.astro", {
  cwd: process.cwd(),
  absolute: true,
});

const sources = {};

for (const filePath of astroFiles) {
  try {
    const content = await readFile(filePath, "utf-8");
    const relativePath = relative(process.cwd(), filePath);
    sources[relativePath] = content;
    console.log(`ðŸ“„ Processed ${relativePath}`);
  } catch (error) {
    console.warn(`âš ï¸ Failed to read ${filePath}:`, error.message);
  }
}

// Generate embedded sources for API route
const embeddedSources = JSON.stringify(sources, null, 2);
const apiRouteContent = `import type { APIRoute } from "astro";
import { handleSnippetRequest } from "@astro-grab/server";
import { handleSnippetRequestFromContent } from "@astro-grab/server";
import type { SnippetResponse } from "@astro-grab/shared";

// Embedded demo sources (generated by build script)
const demoSources = ${embeddedSources};

export const GET: APIRoute = async ({ request }) => {
  const url = new URL(request.url);
  const src = url.searchParams.get("src");
  const contextLinesParam = url.searchParams.get("contextLines");

  if (!src) {
    return new Response(JSON.stringify({ error: "Missing src parameter" }), {
      status: 400,
      headers: { "Content-Type": "application/json" },
    });
  }

  const contextLines = contextLinesParam ? parseInt(contextLinesParam, 10) : 4;

  try {
    let result: SnippetResponse;

    // Try embedded sources first (production/demo)
    if (process.env.NODE_ENV === 'production') {
      // Extract file path from src (remove line:column suffix)
      const filePath = src.split(':')[0];
      if (demoSources && demoSources[filePath]) {
        result = await handleSnippetRequestFromContent(src, demoSources[filePath], {
          contextLines,
        });
      } else {
        throw new Error(\`Source \${filePath} not found in embedded sources\`);
      }
    } else {
      // Development: always use filesystem
      const root = process.cwd();
      result = await handleSnippetRequest(src, { root, contextLines });
    }

    return new Response(JSON.stringify(result), {
      status: 200,
      headers: { "Content-Type": "application/json" },
    });
  } catch (error) {
    console.error("[astro-grab] Snippet extraction failed:", error);
    return new Response(
      JSON.stringify({
        error: error instanceof Error ? error.message : String(error),
      }),
      { status: 500, headers: { "Content-Type": "application/json" } },
    );
  }
};`;

await writeFile("src/pages/api/astro-grab/snippet.ts", apiRouteContent);
console.log(
  `âœ… Generated API route with embedded sources for ${Object.keys(sources).length} files`,
);
