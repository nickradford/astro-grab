import type { APIRoute } from "astro";
import { handleSnippetRequest } from "astro-grab-server";
import { handleSnippetRequestFromContent } from "astro-grab-server";
import type { SnippetResponse } from "astro-grab-shared";

// Embedded demo sources (generated by build script)
const demoSources = {
  "src/pages/index.astro": "---\nimport Layout from \"../layouts/Layout.astro\";\nimport Hero from \"../components/Hero.astro\";\nimport Installation from \"../components/Installation.astro\";\nimport Card from \"../components/Card.astro\";\n\nimport Footer from \"../components/Footer.astro\";\n---\n\n<Layout title=\"astro-grab - Visual element targeting for Astro\">\n  <main>\n    <Hero />\n\n    <section class=\"bg-black py-24\">\n      <div class=\"mx-auto max-w-4xl px-4 text-center sm:px-6 lg:px-8\">\n        <h2\n          class=\"mb-16 text-2xl font-bold tracking-wider text-white uppercase\"\n        >\n          Try It Now\n        </h2>\n        <div id=\"steps-container\" class=\"mb-12 text-left max-w-lg mx-auto\">\n          <ol class=\"list-decimal list-inside space-y-2 text-gray-300\">\n            <li id=\"step-1\">Hit <kbd class=\"bg-gray-800 px-2 py-1 font-mono text-xs text-white\">Cmd+G</kbd> to enter targeting mode</li>\n            <li id=\"step-2\" style=\"height: 0; overflow: hidden; opacity: 0; transition: height 0.3s ease, opacity 0.3s ease;\">Click on any component on this page</li>\n            <li id=\"step-3\" style=\"height: 0; overflow: hidden; opacity: 0; transition: height 0.3s ease, opacity 0.3s ease;\">Paste the copied code into the textarea below</li>\n            <li id=\"step-4\" style=\"height: 0; overflow: hidden; opacity: 0; transition: height 0.3s ease, opacity 0.3s ease;\">Now your AI agent has better context for editing</li>\n          </ol>\n        </div>\n        <!-- Fake Terminal -->\n        <div class=\"mx-auto max-w-2xl\">\n          <div class=\"bg-gray-900 rounded-lg p-6 font-mono text-sm text-green-400 border border-gray-700\">\n            <div class=\"flex items-center mb-4\">\n              <div class=\"w-3 h-3 bg-red-500 rounded-full mr-2\"></div>\n              <div class=\"w-3 h-3 bg-yellow-500 rounded-full mr-2\"></div>\n              <div class=\"w-3 h-3 bg-green-500 rounded-full mr-2\"></div>\n              <span class=\"text-gray-400 text-xs\">agent@astro-grab</span>\n            </div>\n            <div class=\"space-y-4 text-left\">\n              <div>\n                <span class=\"text-green-400 font-bold\">Clog:</span>\n                <span class=\"text-gray-300 ml-2\">What's next on your plate?</span>\n              </div>\n              <div class=\"bg-gray-800 p-3 rounded\">\n                <textarea\n                  id=\"code-input\"\n                  class=\"w-full bg-transparent border-none outline-none resize-none text-gray-300 font-mono text-sm placeholder-gray-500 overflow-hidden\"\n                  rows=\"6\"\n                  placeholder=\"// Paste your copied component code here\"\n                ></textarea>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </section>\n\n    <Installation />\n  </main>\n\n  <Footer />\n\n  <script>\n    document.addEventListener('DOMContentLoaded', () => {\n      const textarea = document.getElementById('code-input');\n      const step2 = document.getElementById('step-2');\n      const step3 = document.getElementById('step-3');\n      const step4 = document.getElementById('step-4');\n      let hasPasted = false;\n\n      if (textarea) {\n        textarea.addEventListener('input', function() {\n          this.style.height = 'auto';\n          this.style.height = this.scrollHeight + 'px';\n        });\n        // Dispatch paste event when content is added\n        const handleInput = () => {\n          if ((textarea as HTMLTextAreaElement).value.trim().length > 0 && !hasPasted) {\n            hasPasted = true;\n            window.dispatchEvent(new CustomEvent('demo:text-pasted'));\n          }\n        };\n        textarea.addEventListener('input', handleInput);\n      }\n\n      // Listen for targeting mode start\n      window.addEventListener('astro-grab:targeting-mode-started', () => {\n        setTimeout(() => {\n          if (step2) {\n            const targetHeight = step2.scrollHeight;\n            step2.style.height = targetHeight + 'px';\n            step2.style.opacity = '1';\n          }\n        }, 500);\n      });\n\n      // Listen for component targeted\n      window.addEventListener('astro-grab:component-targeted', () => {\n        setTimeout(() => {\n          if (step3 && textarea) {\n            const targetHeight = step3.scrollHeight;\n            step3.style.height = targetHeight + 'px';\n            step3.style.opacity = '1';\n            textarea.focus();\n          }\n        }, 500);\n      });\n\n      // Listen for text pasted\n      window.addEventListener('demo:text-pasted', () => {\n        setTimeout(() => {\n          if (step4) {\n            const targetHeight = step4.scrollHeight;\n            step4.style.height = targetHeight + 'px';\n            step4.style.opacity = '1';\n          }\n        }, 500);\n      });\n    });\n  </script>\n</Layout>\n",
  "src/layouts/Layout.astro": "---\ninterface Props {\n  title: string;\n}\n\nconst { title } = Astro.props;\n\nimport \"../styles/global.css\";\n---\n\n<!doctype html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n    <title>{title}</title>\n\n    <link\n      rel=\"stylesheet\"\n      type=\"text/css\"\n      href=\"https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css\"\n    />\n    <link\n      rel=\"stylesheet\"\n      type=\"text/css\"\n      href=\"https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css\"\n      <!--\n      and\n      it's\n      easy\n      to\n      individually\n      load\n      additional\n      languages\n      --\n    />\n  </head>\n  <body class=\"min-h-screen bg-black font-mono leading-relaxed text-white\">\n    <slot />\n  </body>\n</html>\n",
  "src/components/TryItNow.astro": "---\n// TryItNow component\n---\n\n<section id=\"try-it-now\" class=\"bg-black py-24 text-center\">\n  <div class=\"mx-auto max-w-4xl px-4 sm:px-6 lg:px-8\">\n    <h2 class=\"mb-16 text-3xl font-bold tracking-wider text-white uppercase\">\n      Try It Now\n    </h2>\n\n    <div\n      class=\"mb-16 flex flex-col items-center justify-center gap-8 sm:flex-row\"\n    >\n      <div class=\"p-6 text-center transition-all duration-300 hover:scale-105\">\n        <div class=\"mb-4 text-3xl\">üéØ</div>\n        <h3 class=\"mb-2 text-lg font-bold tracking-wide text-white uppercase\">\n          Hold Cmd+G\n        </h3>\n        <p class=\"text-sm text-gray-400\">Enter targeting mode</p>\n      </div>\n\n      <div class=\"p-6 text-center transition-all duration-300 hover:scale-105\">\n        <div class=\"mb-4 text-3xl\">üëÜ</div>\n        <h3 class=\"mb-2 text-lg font-bold tracking-wide text-white uppercase\">\n          Hover Elements\n        </h3>\n        <p class=\"text-sm text-gray-400\">See highlights</p>\n      </div>\n\n      <div class=\"p-6 text-center transition-all duration-300 hover:scale-105\">\n        <div class=\"mb-4 text-3xl\">üìã</div>\n        <h3 class=\"mb-2 text-lg font-bold tracking-wide text-white uppercase\">\n          Click to Copy\n        </h3>\n        <p class=\"text-sm text-gray-400\">Code copied</p>\n      </div>\n\n      <div class=\"p-6 text-center transition-all duration-300 hover:scale-105\">\n        <div class=\"mb-4 text-3xl\">‚å®Ô∏è</div>\n        <h3 class=\"mb-2 text-lg font-bold tracking-wide text-white uppercase\">\n          Press Esc\n        </h3>\n        <p class=\"text-sm text-gray-400\">Exit mode</p>\n      </div>\n    </div>\n\n    <p class=\"mx-auto max-w-2xl text-sm text-gray-400\">\n      Try it on these elements above.\n    </p>\n  </div>\n</section>\n",
  "src/components/Installation.astro": "---\nimport { Code } from \"astro:components\";\n---\n\n<section id=\"installation\" class=\"bg-black py-24\">\n  <div class=\"mx-auto max-w-2xl px-4 sm:px-6 lg:px-8\">\n    <h2\n      class=\"mb-16 text-center text-3xl font-bold tracking-wider text-white uppercase\"\n    >\n      Installation\n    </h2>\n\n    <div class=\"space-y-12\">\n      <div>\n        <h3 class=\"mb-6 text-xl font-bold tracking-wide text-white uppercase\">\n          1. Install Package\n        </h3>\n        <div class=\"relative mb-4 border-2 border-orange-500/50 bg-gray-900\">\n          <Code\n            class=\"p-4\"\n            lang=\"sh\"\n            id=\"install-cmd\"\n            code={`npm install astro-grab`}\n          />\n          <button\n            class=\"copy-btn absolute top-2 right-2 cursor-pointer border border-orange-500 bg-orange-500 px-3 py-1 text-xs text-white transition-all duration-200 hover:bg-orange-600\"\n            onclick=\"copyToClipboard(this, '#install-cmd')\">Copy</button\n          >\n        </div>\n        <p class=\"m-0 text-sm text-gray-400\">\n          Or use <code\n            class=\"bg-gray-800 px-2 py-1 font-mono text-xs text-white\"\n            >bun add astro-grab</code\n          > with Bun.\n        </p>\n      </div>\n\n      <div>\n        <h3 class=\"mb-6 text-xl font-bold tracking-wide text-white uppercase\">\n          2. Add Integration\n        </h3>\n        <div class=\"relative mb-4 border-2 border-orange-500 bg-gray-900\">\n          <Code\n            id=\"astro-config\"\n            lang=\"js\"\n            class=\"p-4\"\n            code={`// astro.config.mjs\nimport { defineConfig } from 'astro/config';\nimport { astroGrab } from 'astro-grab';\n\nexport default defineConfig({\n  integrations: [\n    astroGrab(),\n  ],\n});\n\n/** Here are the options you can pass to \\`astroGrab()\\`\n{\n  enabled: true,        // Enable in dev mode\n  holdDuration: 1000,   // Hold time in ms\n  contextLines: 4,      // Lines around target\n  hue: 30,              // Highlight color (orange)\n  toolbar: true,        // Enable dev toolbar\n}\n*/\n`}\n          />\n          <button\n            onclick=\"copyToClipboard(this, '#astro-config')\"\n            class=\"copy-btn absolute top-2 right-2 cursor-pointer border border-orange-500 bg-orange-500 px-3 py-1 text-xs text-white transition-all duration-200 hover:bg-orange-600\"\n            >Copy</button\n          >\n        </div>\n      </div>\n\n      <div>\n        <h3 class=\"mb-6 text-xl font-bold tracking-wide text-white uppercase\">\n          3. Start Dev Server\n        </h3>\n        <div class=\"relative mb-4 border-2 border-orange-500 bg-gray-900\">\n          <Code id=\"run-cmd\" class=\"p-4\" lang=\"sh\" code={`npm run dev`} />\n          <button\n            class=\"copy-btn absolute top-2 right-2 cursor-pointer border border-orange-500 bg-orange-500 px-3 py-1 text-xs text-white transition-all duration-200 hover:bg-orange-600\"\n            onclick=\"copyToClipboard(this, '#run-cmd')\">Copy</button\n          >\n        </div>\n        <p class=\"m-0 text-sm text-gray-400\">\n          Toolbar appears in Astro dev mode.\n        </p>\n      </div>\n    </div>\n  </div>\n</section>\n\n<script is:inline>\n  function copyToClipboard(el, targetSelector) {\n    const text = document.querySelector(targetSelector).textContent;\n\n    navigator.clipboard.writeText(text).then(() => {\n      const button = el;\n      const originalText = button.textContent;\n      button.textContent = \"Copied!\";\n      button.style.background = \"#000\";\n      button.style.color = \"white\";\n\n      setTimeout(() => {\n        button.textContent = originalText;\n        button.style.background = \"\";\n        button.style.color = \"\";\n      }, 2000);\n    });\n  }\n</script>\n",
  "src/components/Hero.astro": "---\n// Hero component\n---\n\n<div class=\"relative w-full bg-black\">\n  {/* Orange Grid Background */}\n  <div\n    class=\"absolute inset-0 z-0\"\n    style=\"background: #000000; background-image: linear-gradient(to right, rgba(255,165,0,0.2) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,165,0,0.2) 1px, transparent 1px); background-size: 40px 40px;\"\n  >\n  </div>\n  {/* Transparency Mask */}\n  <div\n    class=\"absolute inset-0 z-5\"\n    style=\"background: radial-gradient(circle at center, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 70%);\"\n  >\n  </div>\n  {/* Your Content/Components */}\n  <section class=\"relative z-10 py-24 text-center\">\n    <div class=\"mx-auto max-w-2xl px-4 sm:px-6 lg:px-8\">\n      <h1\n        class=\"mb-6 font-mono text-5xl font-bold tracking-tight text-white sm:text-6xl lg:text-7xl\"\n      >\n        astro-grab\n      </h1>\n      <p class=\"mb-8 text-lg text-gray-400 sm:text-xl\">\n        try it, right now. hit cmd+g\n      </p>\n      <div class=\"flex flex-col items-center justify-center gap-6 sm:flex-row\">\n        <a\n          href=\"#installation\"\n          class=\"bg-orange-500 px-8 py-4 font-bold tracking-wide text-white uppercase transition-colors duration-200 hover:bg-orange-600\"\n          >Get Started</a\n        >\n        <a\n          href=\"https://github.com/nickradford/astro-grab\"\n          target=\"_blank\"\n          class=\"bg-gray-800 px-8 py-4 font-bold tracking-wide text-white uppercase transition-colors duration-200 hover:bg-gray-700\"\n          ><i class=\"ph ph-fill ph-github-logo mr-2\"></i>GitHub</a\n        >\n      </div>\n    </div>\n  </section>\n</div>\n",
  "src/components/Footer.astro": "---\n// Footer component\n---\n\n<footer class=\"bg-black py-12 text-center\">\n  <div class=\"mx-auto max-w-6xl px-4 sm:px-6 lg:px-8\">\n    <p class=\"mb-2 text-xs text-gray-500\">\n      Built with <a\n        href=\"https://github.com/sst/astro-grab\"\n        target=\"_blank\"\n        rel=\"noopener noreferrer\"\n        class=\"text-orange-500 transition-colors duration-200 hover:text-orange-400\"\n        >astro-grab</a>\n    </p>\n    <p class=\"text-xs text-gray-600\">MIT License</p>\n  </div>\n</footer>\n",
  "src/components/Card.astro": "---\ninterface Props {\n  title: string;\n  description: string;\n}\n\nconst { title, description } = Astro.props;\n---\n\n<article class=\"p-6 transition-all duration-300 hover:scale-105\">\n  <h3\n    class=\"mb-4 text-center text-xl font-bold tracking-wide text-white uppercase\"\n  >\n    {title}\n  </h3>\n  <p class=\"m-0 text-center leading-relaxed text-gray-400\">{description}</p>\n</article>\n"
};

export const GET: APIRoute = async ({ request }) => {
  const url = new URL(request.url);
  const src = url.searchParams.get("src");
  const contextLinesParam = url.searchParams.get("contextLines");

  if (!src) {
    return new Response(JSON.stringify({ error: "Missing src parameter" }), {
      status: 400,
      headers: { "Content-Type": "application/json" },
    });
  }

  const contextLines = contextLinesParam ? parseInt(contextLinesParam, 10) : 4;

  try {
    let result: SnippetResponse;

    // Try embedded sources first (production/demo)
    if (process.env.NODE_ENV === 'production') {
      if (demoSources && demoSources[src]) {
        result = await handleSnippetRequestFromContent(src, demoSources[src], {
          contextLines,
        });
      } else {
        throw new Error('Source not found in embedded sources');
      }
    } else {
      // Development: always use filesystem
      const root = process.cwd();
      result = await handleSnippetRequest(src, { root, contextLines });
    }

    return new Response(JSON.stringify(result), {
      status: 200,
      headers: { "Content-Type": "application/json" },
    });
  } catch (error) {
    console.error("[astro-grab] Snippet extraction failed:", error);
    return new Response(
      JSON.stringify({
        error: error instanceof Error ? error.message : String(error),
      }),
      { status: 500, headers: { "Content-Type": "application/json" } },
    );
  }
};