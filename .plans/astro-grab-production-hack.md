# Astro Grab Production Hack - Hybrid Approach Implementation Plan

## Overview

Implement a hybrid approach for astro-grab that enables production snippet extraction while maintaining development workflow:

- **Development**: Use Vite plugin with direct filesystem access to source files
- **Production**: Use pre-extracted `.astro` file content embedded in the build
- **Safety**: Only activates when `ASTRO_GRAB_DANGEROUSLY_FORCE_ENABLE=true` flag is set
- **Impact**: Zero performance/bundle impact on regular users

## Current Problem Analysis

**Development Environment:**

- ‚úÖ Vite plugin can read `.astro` source files from filesystem
- ‚úÖ `handleSnippetRequest` works with `readFile()` from `node:fs/promises`

**Production Environment:**

- ‚ùå Serverless functions can't access source files at runtime
- ‚ùå Vercel's `includeFiles` doesn't work for Astro API routes
- ‚ùå No filesystem access to source files in serverless environment

## Solution Architecture

### 1. Conditional Source Extraction System

**File: `packages/astro-grab/src/source-extractor.ts`**

```typescript
interface AstroSource {
  path: string;
  content: string;
  mtime: number;
}

export class AstroSourceExtractor {
  private sources = new Map<string, AstroSource>();
  private enabled = false;
  private extractedCount = 0;

  enable() {
    this.enabled = true;
  }

  isEnabled(): boolean {
    return this.enabled;
  }

  async extractFromViteBuild(server: any) {
    if (!this.enabled) return;

    console.log("[astro-grab] üîç Scanning for .astro files...");

    // Find all .astro files in the project
    const astroFiles = server.moduleGraph.idToModuleMap
      .keys()
      .filter((id) => id.endsWith(".astro"))
      .map((id) => id.replace(/\?.*$/, "")); // Remove query params

    for (const filePath of astroFiles) {
      try {
        const content = await fs.readFile(filePath, "utf-8");
        const stats = await fs.stat(filePath);

        this.sources.set(filePath, {
          path: filePath,
          content,
          mtime: stats.mtime.getTime(),
        });

        this.extractedCount++;
      } catch (error) {
        console.warn(
          `[astro-grab] Failed to extract ${filePath}:`,
          error.message,
        );
      }
    }

    console.log(
      `[astro-grab] ‚úÖ Extracted ${this.extractedCount} .astro files`,
    );
  }

  getSource(path: string): AstroSource | null {
    return this.sources.get(path) || null;
  }

  generateProductionModule(): string {
    if (!this.sources.size) {
      return "export const astroSources = new Map();";
    }

    const sourcesArray = Array.from(this.sources.entries());
    return `
      // Auto-generated by astro-grab source extractor
      // Contains ${sourcesArray.length} .astro files for production snippet extraction
      export const astroSources = new Map([
        ${sourcesArray
          .map(([path, source]) => `["${path}", ${JSON.stringify(source)}]`)
          .join(",\n        ")}
      ]);
    `;
  }
}
```

### 2. Enhanced Astro Integration

**File: `packages/astro-grab/src/integration.ts`**

```typescript
import { AstroSourceExtractor } from "./source-extractor.js";

export default function astroGrabIntegration(options: AstroGrabOptions = {}) {
  const extractor = new AstroSourceExtractor();

  // Only enable source extraction if dangerous flag is set
  if (process.env.ASTRO_GRAB_DANGEROUSLY_FORCE_ENABLE === "true") {
    extractor.enable();
    console.log(
      "[astro-grab] üö® DANGEROUS MODE ENABLED: Source extraction active",
    );
  }

  return {
    name: "astro-grab-integration",
    hooks: {
      "astro:config:setup": (config) => {
        config.vite.plugins.push(
          astroGrabVitePlugin({ extractor, ...options }),
        );
      },
      "astro:build:done": ({ dir }) => {
        if (extractor.isEnabled()) {
          const sourceModule = extractor.generateProductionModule();
          const outputPath = path.join(dir, "astro-grab-sources.js");

          fs.writeFileSync(outputPath, sourceModule);
          console.log(
            `[astro-grab] üíæ Generated production sources at ${outputPath}`,
          );
        }
      },
    },
  };
}
```

### 3. Enhanced Vite Plugin

**File: `packages/astro-grab-server/src/vite-plugin.ts`**

```typescript
export function astroGrabVitePlugin(options: {
  extractor: AstroSourceExtractor;
}) {
  const { extractor } = options;

  return {
    name: "astro-grab-vite",
    buildStart() {
      if (extractor.isEnabled()) {
        // Extract sources during build start
        extractor.extractFromViteBuild(this);
      }
    },
    generateBundle() {
      if (extractor.isEnabled()) {
        // Emit production source module
        this.emitFile({
          type: "asset",
          fileName: "astro-grab-sources.js",
          source: extractor.generateProductionModule(),
        });
      }
    },
  };
}
```

### 4. Content-Based Snippet Handler

**File: `packages/astro-grab-server/src/snippet-handler-content.ts`**

```typescript
export async function handleSnippetRequestFromContent(
  src: string,
  content: string,
  options: SnippetHandlerOptions,
): Promise<SnippetResponse> {
  const { contextLines = 4 } = options;

  const loc = decodeSourceLocation(decodeURIComponent(src));

  const { snippet, startLine, endLine } = extractSnippet(
    content,
    loc.line,
    contextLines,
  );

  return {
    file: loc.file,
    snippet,
    startLine,
    endLine,
    targetLine: loc.line,
    language: "astro",
  };
}
```

### 5. Hybrid API Route

**File: `apps/demo/src/pages/api/astro-grab/snippet.ts`**

```typescript
// Dynamic import of production sources (only if they exist)
let astroSources: Map<string, any> | null = null;
try {
  const sources = await import("../../../astro-grab-sources.js");
  astroSources = sources.astroSources;
} catch {
  // Sources not generated, will use filesystem fallback
}

export const GET: APIRoute = async ({ request }) => {
  const url = new URL(request.url);
  const src = url.searchParams.get("src");
  const contextLinesParam = url.searchParams.get("contextLines");

  if (!src) {
    return new Response(JSON.stringify({ error: "Missing src parameter" }), {
      status: 400,
      headers: { "Content-Type": "application/json" },
    });
  }

  const contextLines = contextLinesParam ? parseInt(contextLinesParam, 10) : 4;

  try {
    let result: SnippetResponse;

    // Strategy 1: Try embedded production sources
    if (astroSources) {
      const embedded = astroSources.get(src);
      if (embedded) {
        console.log(`[astro-grab] üì¶ Using embedded source for ${src}`);
        result = await handleSnippetRequestFromContent(src, embedded.content, {
          contextLines,
        });
      } else {
        throw new Error(`Source ${src} not found in embedded sources`);
      }
    } else {
      // Strategy 2: Fallback to filesystem (development)
      console.log(`[astro-grab] üíæ Using filesystem for ${src}`);
      const root = process.cwd();
      result = await handleSnippetRequest(src, { root, contextLines });
    }

    return new Response(JSON.stringify(result), {
      status: 200,
      headers: { "Content-Type": "application/json" },
    });
  } catch (error) {
    console.error("[astro-grab] Snippet extraction failed:", error);
    return new Response(
      JSON.stringify({
        error: error instanceof Error ? error.message : String(error),
        details:
          process.env.NODE_ENV === "development" ? error.stack : undefined,
      }),
      {
        status: 500,
        headers: { "Content-Type": "application/json" },
      },
    );
  }
};
```

## Implementation Benefits

### ‚úÖ Safety & Performance

- **Conditional activation**: Only impacts users with `ASTRO_GRAB_DANGEROUSLY_FORCE_ENABLE=true`
- **Minimal bundle impact**: Only `.astro` files included, and only when flag is set
- **Hybrid fallback**: Development uses fast filesystem, production uses embedded content
- **Build-time generation**: Sources generated during build, not in version control

### ‚úÖ User Experience

- **Zero impact on regular users**: No bundle bloat or performance impact
- **Seamless operation**: Same functionality in dev and production
- **Clear error messages**: Better debugging experience with detailed logging

### ‚úÖ Maintainability

- **Clean separation**: Production sources isolated from regular build
- **Opt-in complexity**: Advanced features only for power users
- **Backwards compatible**: Existing functionality unchanged

## File Structure Changes

```
packages/astro-grab/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ source-extractor.ts          # NEW: Astro source extraction logic
‚îÇ   ‚îî‚îÄ‚îÄ integration.ts               # MODIFIED: Conditional extraction
‚îî‚îÄ‚îÄ packages/astro-grab-server/
    ‚îî‚îÄ‚îÄ src/
        ‚îú‚îÄ‚îÄ vite-plugin.ts           # MODIFIED: Source extraction integration
        ‚îî‚îÄ‚îÄ snippet-handler-content.ts # NEW: Content-based snippet extraction

apps/demo/
‚îú‚îÄ‚îÄ src/pages/api/astro-grab/
‚îÇ   ‚îî‚îÄ‚îÄ snippet.ts                   # MODIFIED: Hybrid source loading
‚îî‚îÄ‚îÄ dist/
    ‚îî‚îÄ‚îÄ astro-grab-sources.js        # GENERATED: Production source module
```

## Implementation Order

1. **Create source extractor** (`packages/astro-grab/src/source-extractor.ts`)
2. **Update integration** to conditionally enable extraction
3. **Update Vite plugin** to extract sources during build
4. **Create content-based snippet handler**
5. **Update API route** with hybrid loading logic
6. **Test development mode** (filesystem fallback)
7. **Test production mode** (embedded sources)

## Safety Features

- **Opt-in only**: Only activates with `ASTRO_GRAB_DANGEROUSLY_FORCE_ENABLE=true`
- **Zero regular user impact**: No bundle size increase or performance impact
- **Build-time generation**: Not committed to version control
- **Graceful fallback**: Multiple strategies ensure functionality works
- **Clear logging**: Build process shows extraction progress and any issues</content>
  <parameter name="filePath">.plans/astro-grab-production-hack.md
