---
// WalkthroughSteps.astro - Interactive 4-step walkthrough with highlighting
import ShortcutDisplay from "./ShortcutDisplay.astro";
---

<div id="steps-container" class="mx-auto mb-12 max-w-lg text-left">
  <ol class="list-inside list-decimal space-y-4 text-gray-300">
    <li id="step-1" class="step-active transition-all duration-300">
      Hold <kbd class="bg-gray-800 px-2 py-1 font-mono text-xs text-white">
        <ShortcutDisplay />
      </kbd> for 1 second to enter targeting mode
    </li>
    <li
      id="step-2"
      class="step-pending transition-all duration-300"
      style="height: 0; overflow: hidden; opacity: 0; transition: height 0.3s ease, opacity 0.3s ease;"
    >
      Click on any component on this page
    </li>
    <li
      id="step-3"
      class="step-pending transition-all duration-300"
      style="height: 0; overflow: hidden; opacity: 0; transition: height 0.3s ease, opacity 0.3s ease;"
    >
      Paste the copied code into the textarea below
    </li>
    <li
      id="step-4"
      class="step-pending transition-all duration-300"
      style="height: 0; overflow: hidden; opacity: 0; transition: height 0.3s ease, opacity 0.3s ease;"
    >
      Now your AI agent has better context for editing
    </li>
  </ol>
</div>

<style>
  .step-active {
    padding-left: 1rem;
    border-left: 3px solid #ffa500;
    color: #fff;
    text-shadow: 0 0 10px rgba(255, 165, 0, 0.3);
  }

  .step-completed {
    opacity: 0.5;
    color: #9ca3af;
  }

  .step-pending {
    color: #6b7280;
  }
</style>

<script>
  const step1 = document.getElementById("step-1");
  const step2 = document.getElementById("step-2");
  const step3 = document.getElementById("step-3");
  const step4 = document.getElementById("step-4");

  // Timing tracking for analytics
  let step1Time: number | null = null;
  let step2Time: number | null = null;
  let cmdgTime: number | null = null;
  let step1Count = 0;

  // Track initial keypress
  window.addEventListener("astro-grab:key-held", () => {
    cmdgTime = Date.now();
    if ((window as any).umami) {
      (window as any).umami.track("cmd-g");
    }
  });

  // Step 1 → Step 2: Transition when targeting mode starts
  window.addEventListener("astro-grab:targeting-mode-started", () => {
    step1Time = Date.now();
    step1Count++;

    // Update step states
    if (step1) {
      step1.classList.remove("step-active");
      step1.classList.add("step-completed");
    }

    if ((window as any).umami) {
      (window as any).umami.track("step-1");
      if (step1Count > 1) {
        (window as any).umami.track("repeat-walkthrough", { count: step1Count });
      }
    }

    // Reveal and activate step 2
    setTimeout(() => {
      if (step2) {
        step2.classList.remove("step-pending");
        step2.classList.add("step-active");
        const targetHeight = step2.scrollHeight;
        step2.style.height = targetHeight + "px";
        step2.style.opacity = "1";
      }
    }, 100);
  });

  // Step 2 → Step 3: Transition when component is targeted
  window.addEventListener("astro-grab:component-targeted", (event: any) => {
    step2Time = Date.now();

    // Update step states
    if (step2) {
      step2.classList.remove("step-active");
      step2.classList.add("step-completed");
    }

    if ((window as any).umami) {
      (window as any).umami.track("step-2", { el: event.detail?.el });
      if (step1Time) {
        const duration = step2Time - step1Time;
        (window as any).umami.track("step-1-to-step-2-time", { duration });
      }
    }

    // Reveal and activate step 3
    setTimeout(() => {
      if (step3) {
        step3.classList.remove("step-pending");
        step3.classList.add("step-active");
        const targetHeight = step3.scrollHeight;
        step3.style.height = targetHeight + "px";
        step3.style.opacity = "1";

        // Dispatch event to focus textarea in parent
        window.dispatchEvent(new CustomEvent("walkthrough:focus-textarea"));
      }
    }, 100);
  });

  // Step 3 → Step 4: Transition when text is pasted
  window.addEventListener("demo:text-pasted", () => {
    const step3Time = Date.now();

    // Update step states
    if (step3) {
      step3.classList.remove("step-active");
      step3.classList.add("step-completed");
    }

    if ((window as any).umami) {
      (window as any).umami.track("step-3");
      if (step2Time) {
        const duration = step3Time - step2Time;
        (window as any).umami.track("step-2-to-step-3-time", { duration });
      }
      if (cmdgTime) {
        const totalDuration = step3Time - cmdgTime;
        (window as any).umami.track("total-walkthrough-time", {
          duration: totalDuration,
        });
      }
    }

    // Reveal and activate step 4
    setTimeout(() => {
      if (step4) {
        step4.classList.remove("step-pending");
        step4.classList.add("step-active");
        const targetHeight = step4.scrollHeight;
        step4.style.height = targetHeight + "px";
        step4.style.opacity = "1";
      }
    }, 100);
  });

  // Track early key releases
  window.addEventListener("astro-grab:keypress-too-short", () => {
    if ((window as any).umami) {
      (window as any).umami.track("keypress-too-short");
    }
  });

  // Track targeting cancellations
  window.addEventListener("astro-grab:targeting-cancelled", () => {
    if ((window as any).umami) {
      (window as any).umami.track("targeting-cancelled");
    }
  });
</script>
